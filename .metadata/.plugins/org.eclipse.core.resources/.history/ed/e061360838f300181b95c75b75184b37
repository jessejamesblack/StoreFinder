package com.example.demo;

import org.springframework.http.HttpEntity;
import org.springframework.http.HttpHeaders;
import org.springframework.http.HttpMethod;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RestController;
import org.springframework.web.client.RestTemplate;

import com.google.gson.Gson;
import com.google.gson.JsonObject;

import java.util.HashMap;
import java.util.Map;
import java.text.MessageFormat;
import java.util.Base64;


@RestController
public class dfWebhook {
	
	//Test Get method
	@GetMapping("/test")
	   public String index() {
		return "Hello World";
	}
	
	
	
	//Make POST request to the webhook.
	@PostMapping("/getStocksForBot")
	   public String botStuff(@RequestBody String payload) {
		
		
		//Get the fulfillment request JSON from Dialogflow.
		Gson gson = new Gson();
		JsonParse jp = gson.fromJson(payload, JsonParse.class);
		
		
		//get the response from pizza intent
		if(jp.queryResult.action.equals("input.pizza") )
		{
			
			String username = "217e5e147ad693ead06cf92cbe59f753";
			String password = "3148d7ab9dd26c3c9d6c2b10afec25bf";
						
			String auth = (username + ":" + password);
		    
		    //setup the chatbot's response back to the user
		    String chat = "You don't get pizza";
		    //setup url
		    String string = "";
		    String encodedString = Base64.getEncoder().encodeToString(auth.getBytes());
		    Object[] account = new Object[]{string};
		    String msg = MessageFormat.format("https://haveibeenpwned.com/api/v2/breachedaccount/", account);
		    
		    //setup API call to haveibeenpwned
		    final String uri = string;
		    HttpHeaders headers = new HttpHeaders();
		    headers.add("Authorization","Basic ", encodedString);
		    RestTemplate restTemplate = new RestTemplate();
		    HttpEntity<String> request = new HttpEntity<String>(headers);
		    ResponseEntity<String> response = restTemplate.exchange(uri, HttpMethod.GET, request, String.class);
		    
		    // Dialogflow V2 requires the fulfillment response come back as fulfillmentText.
		    JsonObject chatConvert = new JsonObject();
		    chatConvert.addProperty("fulfillmentText", chat);
		    
		    String responsePayload = gson.toJson(chatConvert);
		    
		    //Return to DialogFlow
		    return responsePayload;
		    		      
		}
		else
		{
			System.out.println("Oof");
			return "oof";
		}
		

	}

}
